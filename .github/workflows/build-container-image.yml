name: build-container-image

on:
  push

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: Build with Maven
        run: mvn --batch-mode --update-snapshots verify

      - name: Build all Modules
        run: mvn clean install

      - name: Print short SHA
        env:
          IMAGE_TAG: "ghcr.io/eclipse-researchlabs/smartclide/smartclide-monitoring:" + ${GITHUB_SHA::8}
        run: echo "${IMAGE_TAG}"

      - name: Build Image
        env:
          CONTAINER_REGISTRY_USERNAME: ${GITHUB_ACTOR}
          CONTAINER_REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_TAG: "ghcr.io/eclipse-researchlabs/smartclide/smartclide-monitoring:" + ${GITHUB_SHA::8}
        run: mvn compile jib:build -pl smartclide-monitoring -Djib.to.auth.username="${CONTAINER_REGISTRY_USERNAME}" -Djib.to.auth.password="${CONTAINER_REGISTRY_TOKEN}" -Djib.to.tags="${IMAGE_TAG}"

